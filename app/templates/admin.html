<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AlphaBook</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 14px;
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    .admin-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .admin-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
    }

    .users-table th {
      background: var(--bg);
      padding: 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
    }

    .users-table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    .users-table tr:hover {
      background: rgba(108, 92, 231, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-admin {
      background: rgba(108, 92, 231, 0.2);
      color: var(--brand);
    }

    .badge-blacklisted {
      background: rgba(255, 107, 107, 0.2);
      color: var(--red);
    }

    .badge-active {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 5px;
      transition: all 0.2s;
    }

    .btn-blacklist {
      background: rgba(255, 107, 107, 0.2);
      color: var(--red);
    }

    .btn-blacklist:hover {
      background: var(--red);
      color: white;
    }

    .btn-unblacklist {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .btn-unblacklist:hover {
      background: var(--green);
      color: white;
    }

    .btn-delete {
      background: rgba(255, 107, 107, 0.3);
      color: var(--red);
    }

    .btn-delete:hover {
      background: var(--red);
      color: white;
    }

    .leaderboard-rank {
      font-size: 20px;
      font-weight: 700;
      width: 40px;
      text-align: center;
    }

    .rank-1 { color: #FFD700; }
    .rank-2 { color: #C0C0C0; }
    .rank-3 { color: #CD7F32; }

    .pnl-positive { color: var(--green); font-weight: 600; }
    .pnl-negative { color: var(--red); font-weight: 600; }

    .danger-zone {
      background: rgba(255, 107, 107, 0.1);
      border: 2px solid rgba(255, 107, 107, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }

    .danger-zone h3 {
      color: var(--red);
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container nav-content">
      <div class="brand">
        <span class="logo">üìä</span>
        <span class="name">AlphaBook Admin</span>
      </div>
      <div class="nav-links">
        <a href="/">Trading</a>
        <a href="/dashboard">Dashboard</a>
        <a href="/admin" class="active">Admin</a>
        <span>{{ user.username }}</span>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top: 40px; max-width: 1400px;">
    <div class="admin-header">
      <h1>üõ°Ô∏è Admin Control Panel</h1>
      <p>Manage users, view analytics, and control the platform</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value">{{ total_users }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Users</div>
        <div class="stat-value">{{ users | selectattr('is_blacklisted', 'equalto', false) | list | length }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Blacklisted</div>
        <div class="stat-value">{{ users | selectattr('is_blacklisted', 'equalto', true) | list | length }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Volume</div>
        <div class="stat-value">{{ users | sum(attribute='trades') }}</div>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('users')">All Users</button>
      <button class="admin-tab" onclick="switchTab('leaderboard')">Leaderboard</button>
      <button class="admin-tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- All Users Tab -->
    <div id="users-tab" class="tab-content active">
      <table class="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Balance</th>
            <th>P&L</th>
            <th>Orders</th>
            <th>Trades</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>
              <strong>{{ u.username }}</strong>
              {% if u.is_admin %}
              <span class="badge badge-admin">Admin</span>
              {% endif %}
            </td>
            <td>${{ "%.2f" | format(u.balance) }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}${{ "%.2f" | format(u.pnl) }}
            </td>
            <td>{{ u.orders }}</td>
            <td>{{ u.trades }}</td>
            <td>
              {% if u.is_blacklisted %}
              <span class="badge badge-blacklisted">Blacklisted</span>
              {% else %}
              <span class="badge badge-active">Active</span>
              {% endif %}
            </td>
            <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
            <td>
              {% if not u.is_admin %}
                {% if u.is_blacklisted %}
                <button class="action-btn btn-unblacklist" onclick="unblacklistUser({{ u.id }})">Unban</button>
                {% else %}
                <button class="action-btn btn-blacklist" onclick="blacklistUser({{ u.id }})">Ban</button>
                {% endif %}
                <button class="action-btn btn-delete" onclick="deleteUser({{ u.id }}, '{{ u.username }}')">Delete</button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Leaderboard Tab -->
    <div id="leaderboard-tab" class="tab-content">
      <table class="users-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Username</th>
            <th>Balance</th>
            <th>P&L</th>
            <th>Total Trades</th>
            <th>ROI</th>
          </tr>
        </thead>
        <tbody>
          {% for u in leaderboard %}
          <tr>
            <td class="leaderboard-rank rank-{{ loop.index if loop.index <= 3 else '' }}">
              {% if loop.index == 1 %}ü•á
              {% elif loop.index == 2 %}ü•à
              {% elif loop.index == 3 %}ü•â
              {% else %}{{ loop.index }}
              {% endif %}
            </td>
            <td>
              <strong>{{ u.username }}</strong>
              {% if u.is_admin %}
              <span class="badge badge-admin">Admin</span>
              {% endif %}
            </td>
            <td>${{ "%.2f" | format(u.balance) }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}${{ "%.2f" | format(u.pnl) }}
            </td>
            <td>{{ u.trades }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}{{ "%.1f" | format((u.pnl / 10000.0) * 100) }}%
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="danger-zone">
        <h3>‚ö†Ô∏è Danger Zone</h3>
        <p style="margin-bottom: 20px;">These actions are irreversible. Use with caution.</p>
        <button class="btn primary" style="background: var(--red);" onclick="resetAllUsers()">
          Reset All Users to Initial State
        </button>
        <p class="small" style="margin-top: 10px; color: var(--muted);">
          This will reset all non-admin users to $10,000 balance and delete all orders and trades.
        </p>
      </div>
    </div>
  </div>

  <script>
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    async function blacklistUser(userId) {
      if (!confirm('Are you sure you want to blacklist this user?')) return;

      try {
        const res = await fetch(`/admin/users/${userId}/blacklist`, {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User blacklisted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to blacklist user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function unblacklistUser(userId) {
      try {
        const res = await fetch(`/admin/users/${userId}/unblacklist`, {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User unblacklisted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to unblacklist user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to permanently delete user "${username}"? This cannot be undone.`)) return;

      try {
        const res = await fetch(`/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User deleted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to delete user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function resetAllUsers() {
      const confirmation = prompt('This will reset ALL users to $10,000 and delete all orders/trades. Type "RESET" to confirm:');
      if (confirmation !== 'RESET') return;

      try {
        const res = await fetch('/admin/reset-all', {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('All users have been reset successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to reset users'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }
  </script>
</body>
</html>