<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AlphaBook</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 14px;
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }

    .admin-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .admin-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
    }

    .users-table th {
      background: var(--bg);
      padding: 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
    }

    .users-table td {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    .users-table tr:hover {
      background: rgba(108, 92, 231, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-admin {
      background: rgba(108, 92, 231, 0.2);
      color: var(--brand);
    }

    .badge-blacklisted {
      background: rgba(255, 107, 107, 0.2);
      color: var(--red);
    }

    .badge-active {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 5px;
      transition: all 0.2s;
    }

    /* Unified style for custom game action buttons */
    .btn-game {
      background: rgba(108, 92, 231, 0.18);
      color: var(--brand);
    }

    .btn-game:hover {
      background: var(--brand);
      color: #ffffff;
    }

    .btn-blacklist {
      background: rgba(255, 107, 107, 0.2);
      color: var(--red);
    }

    .btn-blacklist:hover {
      background: var(--red);
      color: white;
    }

    .btn-unblacklist {
      background: rgba(46, 204, 113, 0.2);
      color: var(--green);
    }

    .btn-unblacklist:hover {
      background: var(--green);
      color: white;
    }

    .btn-delete {
      background: rgba(255, 107, 107, 0.3);
      color: var(--red);
    }

    .btn-delete:hover {
      background: var(--red);
      color: white;
    }

    .leaderboard-rank {
      font-size: 20px;
      font-weight: 700;
      width: 40px;
      text-align: center;
    }

    .rank-1 {
      color: #FFD700;
    }

    .rank-2 {
      color: #C0C0C0;
    }

    .rank-3 {
      color: #CD7F32;
    }

    .pnl-positive {
      color: var(--green);
      font-weight: 600;
    }

    .pnl-negative {
      color: var(--red);
      font-weight: 600;
    }

    .danger-zone {
      background: rgba(255, 107, 107, 0.1);
      border: 2px solid rgba(255, 107, 107, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }

    .danger-zone h3 {
      color: var(--red);
      margin-bottom: 15px;
    }

    .logo-img {
      height: 28px;
      width: auto;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="container nav-content">
      <div class="brand">
        <div class="logo">
          <img src="/static/alphabook.png" alt="AlphaBook" class="logo-img">
        </div>
        <span class="name">AlphaBook Admin</span>
      </div>
      <div class="nav-links">
        <a href="/">Trading</a>
        <span>{{ user.username }}</span>
        <form method="post" action="/logout" style="display:inline; margin-left: 10px;">
          <button type="submit"
            style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 8px; color: var(--text); cursor: pointer; font-size: 14px; font-weight: 600;">Quit</button>
        </form>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top: 40px; max-width: 1400px;">
    <div class="admin-header">
      <h1>üõ°Ô∏è Admin Control Panel</h1>
      <p>Manage users, view analytics, and control the platform</p>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value">{{ total_users }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Active Users</div>
        <div class="stat-value">{{ users | selectattr('is_blacklisted', 'equalto', false) | list | length }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Blacklisted</div>
        <div class="stat-value">{{ users | selectattr('is_blacklisted', 'equalto', true) | list | length }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Volume</div>
        <div class="stat-value">{{ users | sum(attribute='trades') }}</div>
      </div>
    </div>

    <div class="admin-tabs">
      <button class="admin-tab" data-tab="users" onclick="switchTab('users', this)">All Users</button>
      <button class="admin-tab" data-tab="games" onclick="switchTab('games', this)">Custom Games</button>
      <button class="admin-tab" data-tab="leaderboard" onclick="switchTab('leaderboard', this)">Leaderboard</button>
      <button class="admin-tab" data-tab="news" onclick="switchTab('news', this)">Market News</button>
      <button class="admin-tab" data-tab="settings" onclick="switchTab('settings', this)">Settings</button>
    </div>

    <!-- All Users Tab -->
    <div id="users-tab" class="tab-content active">
      <table class="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Balance</th>
            <th>P&L</th>
            <th>Orders</th>
            <th>Trades</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>
              <strong>{{ u.username }}</strong>
              {% if u.is_admin %}
              <span class="badge badge-admin">Admin</span>
              {% endif %}
            </td>
            <td>${{ "%.2f" | format(u.balance) }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}${{ "%.2f" | format(u.pnl) }}
            </td>
            <td>{{ u.orders }}</td>
            <td>{{ u.trades }}</td>
            <td>
              {% if u.is_blacklisted %}
              <span class="badge badge-blacklisted">Blacklisted</span>
              {% else %}
              <span class="badge badge-active">Active</span>
              {% endif %}
            </td>
            <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
            <td>
              {% if not u.is_admin %}
              {% if u.is_blacklisted %}
              <button class="action-btn btn-unblacklist" onclick="unblacklistUser({{ u.id }})">Unban</button>
              {% else %}
              <button class="action-btn btn-blacklist" onclick="blacklistUser({{ u.id }})">Ban</button>
              {% endif %}
              <button class="action-btn btn-delete" onclick="deleteUser({{ u.id }}, '{{ u.username }}')">Delete</button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Custom Games Tab -->
    <div id="games-tab" class="tab-content">
      <div style="margin-bottom: 20px;">
        <button class="btn primary" onclick="openGameModal()">Create New Game</button>
      </div>

      <table class="users-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th>Instructions</th>
            <th>Expected Value</th>
            <th>Visible</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for game in games %}
          <tr>
            <td><strong>{{ game.symbol }}</strong></td>
            <td>{{ game.name }}</td>
            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              {{ game.instructions }}
            </td>
            <td>${{ "%.2f" | format(game.expected_value) }}</td>

            <!-- Visible column -->
            <td>
              {% if game.is_visible %}
              <span class="badge badge-active">Shown</span>
              {% else %}
              <span class="badge">Hidden</span>
              {% endif %}
            </td>

            <!-- Status column: paused or live -->
            <td>
              {% if game.is_paused %}
              <span class="badge badge-blacklisted">Paused</span>
              {% else %}
              <span class="badge badge-active">Live</span>
              {% endif %}
            </td>

            <td>{{ game.created_at.strftime('%Y-%m-%d') }}</td>
            <td>
              <!-- 1) Edit -->
              <button class="action-btn btn-game"
                onclick="editGame({{ game.id }}, '{{ game.symbol }}', '{{ game.name }}', '{{ game.instructions }}', {{ game.expected_value }})">
                Edit
              </button>

              <!-- 2) Pause / Resume -->
              {% if game.is_paused %}
              <button class="action-btn btn-game" onclick="resumeGame({{ game.id }}, '{{ game.symbol }}')">
                Resume
              </button>
              {% else %}
              <button class="action-btn btn-game" onclick="pauseGame({{ game.id }}, '{{ game.symbol }}')">
                Pause
              </button>
              {% endif %}

              <!-- 3) Show / Hide -->
              {% if game.is_visible %}
              <button class="action-btn btn-game" onclick="hideGame({{ game.id }}, '{{ game.symbol }}')">
                Hide
              </button>
              {% else %}
              <button class="action-btn btn-game" onclick="showGame({{ game.id }}, '{{ game.symbol }}')">
                Show
              </button>
              {% endif %}

              <!-- 4) Delete -->
              <button class="action-btn btn-game" onclick="deleteGame({{ game.id }}, '{{ game.symbol }}')">
                Delete
              </button>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" style="text-align: center; color: var(--muted); padding: 40px;">
              No custom games created yet. Click "Create New Game" to get started.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Game Modal -->
    <dialog id="game-modal" class="modal">
      <div class="panel">
        <div class="panel-head">
          <h3 id="game-modal-title">Create New Game</h3>
          <button class="icon-close" onclick="closeGameModal()">‚úï</button>
        </div>
        <form id="game-form">
          <div class="panel-body">
            <div class="field">
              <label>Symbol (must start with GAME)</label>
              <input type="text" id="game-symbol" placeholder="GAME1" required pattern="GAME.*" />
            </div>
            <div class="field">
              <label>Name (displayed to users)</label>
              <input type="text" id="game-name" placeholder="Will it rain tomorrow?" required />
            </div>
            <div class="field">
              <label>Instructions (displayed to users)</label>
              <textarea id="game-instructions" rows="4"
                placeholder="Trade YES if you think it will rain, NO if you think it won't. Market resolves at 8 PM tonight."
                required
                style="background: #0e1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; width: 100%; font-family: inherit;"></textarea>
            </div>
            <div class="field">
              <label>Expected Value (hidden from users, used for P&L)</label>
              <input type="number" id="game-expected" step="0.01" placeholder="100.00" required />
            </div>
            <div class="field">
              <label>Game Type</label>
              <select id="game-type"
                style="background: #0e1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;">
                <option value="market">Market Simulation</option>
                <option value="5os">5Os</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="small" id="game-hint"></div>
          </div>
          <div class="panel-foot">
            <button type="button" class="btn ghost" onclick="closeGameModal()">Cancel</button>
            <button type="submit" class="btn primary" id="game-submit">Create Game</button>
          </div>
        </form>
      </div>
    </dialog>

    <style>
      .modal {
        border: none;
        padding: 0;
        background: transparent;
      }

      .modal::backdrop {
        background: rgba(0, 0, 0, 0.6);
      }
    </style>

    <script>
      let editingGameId = null;

      function openGameModal(editing = false) {
        editingGameId = null;
        document.getElementById('game-modal-title').textContent = 'Create New Game';
        document.getElementById('game-submit').textContent = 'Create Game';
        document.getElementById('game-form').reset();
        document.getElementById('game-symbol').disabled = false;
        document.getElementById('game-modal').showModal();
      }

      function editGame(id, symbol, name, instructions, expectedValue) {
        editingGameId = id;
        document.getElementById('game-modal-title').textContent = 'Edit Game';
        document.getElementById('game-submit').textContent = 'Update Game';
        document.getElementById('game-symbol').value = symbol;
        document.getElementById('game-symbol').disabled = true;
        document.getElementById('game-name').value = name;
        document.getElementById('game-instructions').value = instructions;
        document.getElementById('game-expected').value = expectedValue;
        document.getElementById('game-modal').showModal();
      }

      function closeGameModal() {
        document.getElementById('game-modal').close();
        editingGameId = null;
      }

      document.getElementById('game-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const symbol = document.getElementById('game-symbol').value.toUpperCase().trim();
        const name = document.getElementById('game-name').value.trim();
        const instructions = document.getElementById('game-instructions').value.trim();
        const expectedValue = parseFloat(document.getElementById('game-expected').value);

        const hint = document.getElementById('game-hint');
        const submitBtn = document.getElementById('game-submit');

        hint.textContent = editingGameId ? 'Updating...' : 'Creating...';
        submitBtn.disabled = true;

        try {
          const url = editingGameId ? `/admin/games/${editingGameId}` : '/admin/games';
          const method = editingGameId ? 'PUT' : 'POST';

          const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              symbol,
              name,
              instructions,
              expected_value: expectedValue,
              game_type: document.getElementById('game-type').value
            })
          });

          if (res.ok) {
            hint.textContent = editingGameId ? 'Game updated!' : 'Game created!';
            setTimeout(() => {
              closeGameModal();
              location.reload();
            }, 500);
          } else {
            const data = await res.json();
            hint.textContent = 'Error: ' + (data.detail || 'Failed to save game');
            submitBtn.disabled = false;
          }
        } catch (err) {
          hint.textContent = 'Network error: ' + err.message;
          submitBtn.disabled = false;
        }
      });

      async function deleteGame(gameId, symbol) {
        if (!confirm(`Are you sure you want to delete ${symbol}? This will deactivate the game but preserve trading history.`)) return;

        try {
          const res = await fetch(`/admin/games/${gameId}`, {
            method: 'DELETE',
            credentials: 'include'
          });

          if (res.ok) {
            alert('Game deleted successfully');
            location.reload();
          } else {
            const data = await res.json();
            alert('Error: ' + (data.detail || 'Failed to delete game'));
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }

      async function showGame(gameId, symbol) {
        if (!confirm(`Show game ${symbol} to users?`)) return;

        try {
          const res = await fetch(`/admin/games/${gameId}/show`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'Failed to show game');
          }

          location.reload();
        } catch (err) {
          console.error('showGame failed', err);
          alert('Error showing game: ' + err.message);
        }
      }

      async function hideGame(gameId, symbol) {
        if (!confirm(`Hide game ${symbol} from users?`)) return;

        try {
          const res = await fetch(`/admin/games/${gameId}/hide`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'Failed to hide game');
          }

          location.reload();
        } catch (err) {
          console.error('hideGame failed', err);
          alert('Error hiding game: ' + err.message);
        }
      }

      async function pauseGame(gameId, symbol) {
        if (!confirm(`Pause trading for ${symbol}?`)) return;

        try {
          const res = await fetch(`/admin/games/${gameId}/pause`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'Failed to pause game');
          }

          location.reload();
        } catch (err) {
          console.error('pauseGame failed', err);
          alert('Error pausing game: ' + err.message);
        }
      }

      async function resumeGame(gameId, symbol) {
        if (!confirm(`Resume trading for ${symbol}?`)) return;

        try {
          const res = await fetch(`/admin/games/${gameId}/resume`, {
            method: 'POST',
            credentials: 'include'
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            throw new Error(data.detail || 'Failed to resume game');
          }

          location.reload();
        } catch (err) {
          console.error('resumeGame failed', err);
          alert('Error resuming game: ' + err.message);
        }
      }
    </script>

    <!-- Leaderboard Tab -->
    <div id="leaderboard-tab" class="tab-content">
      <table class="users-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Username</th>
            <th>Balance</th>
            <th>P&L</th>
            <th>Total Trades</th>
            <th>ROI</th>
          </tr>
        </thead>
        <tbody>
          {% for u in leaderboard %}
          <tr>
            <td class="leaderboard-rank rank-{{ loop.index if loop.index <= 3 else '' }}">
              {% if loop.index == 1 %}ü•á
              {% elif loop.index == 2 %}ü•à
              {% elif loop.index == 3 %}ü•â
              {% else %}{{ loop.index }}
              {% endif %}
            </td>
            <td>
              <strong>{{ u.username }}</strong>
              {% if u.is_admin %}
              <span class="badge badge-admin">Admin</span>
              {% endif %}
            </td>
            <td>${{ "%.2f" | format(u.balance) }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}${{ "%.2f" | format(u.pnl) }}
            </td>
            <td>{{ u.trades }}</td>
            <td class="{% if u.pnl >= 0 %}pnl-positive{% else %}pnl-negative{% endif %}">
              {{ "+" if u.pnl >= 0 else "" }}{{ "%.1f" | format((u.pnl / 10000.0) * 100) }}%
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Market News Tab -->
    <div id="news-tab" class="tab-content">
      <div class="card">
        <h2>Market News</h2>
        <p class="small" style="color: var(--muted); margin-bottom: 16px;">
          Admin can publish short messages here. Users will see them on the trading page in the <strong>Market
            Updates</strong> panel.
        </p>

        <!-- Create news -->
        <div style="margin-bottom: 24px;">
          <label for="news-input" class="small" style="display:block; margin-bottom:4px;">New message</label>
          <div style="display:flex; gap:8px;">
            <input id="news-input" type="text" placeholder="Type market news here..."
              style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#050814; color:#fff;" />
            <button class="btn primary" type="button" onclick="createNews()">Publish</button>
          </div>
          <div id="news-hint" class="small" style="margin-top:6px; color: var(--muted);"></div>
        </div>

        <!-- News list -->
        <div>
          <h3 style="margin-bottom:8px;">Existing News</h3>
          <div id="admin-news-list" class="card" style="padding:0; border:none;"></div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings-tab" class="tab-content">
      <div class="danger-zone">
        <h3>‚ö†Ô∏è Danger Zone</h3>
        <p style="margin-bottom: 20px;">These actions are irreversible. Use with caution.</p>
        <button class="btn primary" style="background: var(--red);" onclick="resetAllUsers()">
          Reset All Users to Initial State
        </button>
        <p class="small" style="margin-top: 10px; color: var(--muted);">
          This will reset all non-admin users to $10,000 balance and delete all orders and trades.
        </p>
      </div>
    </div>
  </div>

  <script>
    function switchTab(tabName, btn) {
      try {
        localStorage.setItem('adminActiveTab', tabName);
      } catch (_) {
      }

      document.querySelectorAll('.admin-tab').forEach(el => {
        el.classList.remove('active');
      });

      if (!btn) {
        btn = document.querySelector(`.admin-tab[data-tab="${tabName}"]`);
      }
      if (btn) {
        btn.classList.add('active');
      }

      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      const activeContent = document.getElementById(tabName + '-tab');
      if (activeContent) {
        activeContent.classList.add('active');
      }
    }

    async function blacklistUser(userId) {
      if (!confirm('Are you sure you want to blacklist this user?')) return;

      try {
        const res = await fetch(`/admin/users/${userId}/blacklist`, {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User blacklisted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to blacklist user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function unblacklistUser(userId) {
      try {
        const res = await fetch(`/admin/users/${userId}/unblacklist`, {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User unblacklisted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to unblacklist user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to permanently delete user "${username}"? This cannot be undone.`)) return;

      try {
        const res = await fetch(`/admin/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (res.ok) {
          alert('User deleted successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to delete user'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    async function resetAllUsers() {
      const confirmation = prompt('This will reset ALL users to $10,000 and delete all orders/trades. Type "RESET" to confirm:');
      if (confirmation !== 'RESET') return;

      try {
        const res = await fetch('/admin/reset-all', {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          alert('All users have been reset successfully');
          location.reload();
        } else {
          const data = await res.json();
          alert('Error: ' + (data.detail || 'Failed to reset users'));
        }
      } catch (err) {
        alert('Network error: ' + err.message);
      }
    }

    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    async function loadAdminNews() {
      const container = document.getElementById('admin-news-list');
      if (!container) return;

      container.innerHTML = '<div style="padding:12px;" class="small">Loading‚Ä¶</div>';

      try {
        const res = await fetch('/news?limit=100', { credentials: 'include' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const items = await res.json();

        if (!items.length) {
          container.innerHTML = '<div style="padding:12px;" class="small">No news yet.</div>';
          return;
        }

        container.innerHTML = items
          .map((n) => {
            const dt = new Date(n.created_at);
            const ts = dt.toLocaleString();
            const safeContent = escapeHtml(n.content);
            return (
              '<div class="users-row" style="display:flex; align-items:flex-start; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border);">' +
              '<div>' +
              '<div class="small" style="color:var(--muted);">' + ts + '</div>' +
              '<div class="admin-news-content" data-news-id="' + n.id + '">' + safeContent + '</div>' +
              '</div>' +
              '<div style="display:flex; gap:6px; flex-shrink:0; margin-left:12px;">' +
              '<button class="action-btn" onclick="editNews(' + n.id + ')">Edit</button>' +
              '<button class="action-btn btn-delete" onclick="deleteNewsItem(' + n.id + ')">Delete</button>' +
              '</div>' +
              '</div>'
            );
          })
          .join('');
      } catch (err) {
        console.error('loadAdminNews failed', err);
        container.innerHTML = '<div style="padding:12px;" class="small">Failed to load news: ' + err.message + '</div>';
      }
    }

    async function createNews() {
      const input = document.getElementById('news-input');
      const hint = document.getElementById('news-hint');
      if (!input || !hint) return;

      const content = (input.value || '').trim();
      if (!content) {
        hint.textContent = 'Content cannot be empty.';
        return;
      }

      hint.textContent = 'Publishing‚Ä¶';

      try {
        const res = await fetch('/admin/news', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Failed to publish news');
        }

        input.value = '';
        hint.textContent = 'News published.';
        loadAdminNews();
      } catch (err) {
        console.error('createNews failed', err);
        hint.textContent = 'Error: ' + err.message;
      }
    }

    async function editNews(id) {
      const contentEl = document.querySelector('.admin-news-content[data-news-id="' + id + '"]');
      const current = contentEl ? contentEl.textContent : '';
      const next = prompt('Edit news:', current || '');
      if (next === null) return;

      const trimmed = next.trim();
      if (!trimmed) return;

      try {
        const res = await fetch('/admin/news/' + id, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: trimmed })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Failed to update news');
        }

        loadAdminNews();
      } catch (err) {
        console.error('editNews failed', err);
        alert('Error updating news: ' + err.message);
      }
    }

    async function deleteNewsItem(id) {
      if (!confirm('Delete this news item?')) return;

      try {
        const res = await fetch('/admin/news/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.detail || 'Failed to delete news');
        }

        loadAdminNews();
      } catch (err) {
        console.error('deleteNewsItem failed', err);
        alert('Error deleting news: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      let savedTab = 'users';
      try {
        const stored = localStorage.getItem('adminActiveTab');
        if (stored) savedTab = stored;
      } catch (_) {
      }

      const btn = document.querySelector(`.admin-tab[data-tab="${savedTab}"]`);
      switchTab(savedTab, btn);

      loadAdminNews();
    });
  </script>
</body>

</html>